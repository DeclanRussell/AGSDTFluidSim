#ifndef OPENGLWIDGET_H
#define OPENGLWIDGET_H

//----------------------------------------------------------------------------------------------------------------------
/// @file OpenGLWidget.h
/// @class OpenGLWidget
/// @brief Basic Qt widget that holds a OpenGL context
/// @author Declan Russell
/// @version 1.0
/// @date 2/3/15 Initial version
//----------------------------------------------------------------------------------------------------------------------

#include <ngl/NGLInit.h>
#include <ngl/Mat4.h>
#include <ngl/Vec3.h>
#include <ngl/Camera.h>
#include <ngl/Text.h> //<-- for writting in GL
#include <QGLWidget>
#include <QEvent>
#include <QResizeEvent>
#include <QMessageBox>
#include <QString>
#include <QTime>
#include <QColor>

#include "SPHEngine.h"
#include "FluidShader.h"

class OpenGLWidget : public QGLWidget
{
    Q_OBJECT //must include to gain access to qt stuff

public:
    //----------------------------------------------------------------------------------------------------------------------
    /// @brief ctor for our NGL drawing class
    /// @param [in] parent the parent window to the class
    //----------------------------------------------------------------------------------------------------------------------
    explicit OpenGLWidget(const QGLFormat _format, QWidget *_parent=0);
    //----------------------------------------------------------------------------------------------------------------------
    /// @brief dtor must close down and release OpenGL resources
    //----------------------------------------------------------------------------------------------------------------------
    ~OpenGLWidget();
    //----------------------------------------------------------------------------------------------------------------------
    /// @brief the virtual initialize class is called once when the window is created and we have a valid GL context
    /// use this to setup any default GL stuff
    //----------------------------------------------------------------------------------------------------------------------
    void initializeGL();
    //----------------------------------------------------------------------------------------------------------------------
    /// @brief this is called everytime we want to draw the scene
    //----------------------------------------------------------------------------------------------------------------------
    void paintGL();
    //----------------------------------------------------------------------------------------------------------------------
    /// @brief called to resize the window
    //----------------------------------------------------------------------------------------------------------------------
    void resizeGL(const int _w, const int _h );
    //----------------------------------------------------------------------------------------------------------------------
    /// @brief keyboard press event
    //----------------------------------------------------------------------------------------------------------------------
    void keyPressEvent(QKeyEvent *_event);
    //----------------------------------------------------------------------------------------------------------------------
    /// @brief mouse move
    //----------------------------------------------------------------------------------------------------------------------
    void mouseMoveEvent(QMouseEvent *_event);
    //----------------------------------------------------------------------------------------------------------------------
    /// @brief mouse button release
    //----------------------------------------------------------------------------------------------------------------------
    void mouseReleaseEvent(QMouseEvent *_event);
    //----------------------------------------------------------------------------------------------------------------------
    /// @brief mouse button press
    //----------------------------------------------------------------------------------------------------------------------
    void mousePressEvent(QMouseEvent *_event);
    //----------------------------------------------------------------------------------------------------------------------
    /// @brief this method is called everytime the mouse wheel is moved
    /// inherited from QObject and overridden here.
    /// @param _event the Qt Event structure
    //----------------------------------------------------------------------------------------------------------------------
    void wheelEvent( QWheelEvent *_event);
    //----------------------------------------------------------------------------------------------------------------------
    /// @brief a timer event function from the Q_object
    //----------------------------------------------------------------------------------------------------------------------
    void timerEvent(QTimerEvent *);
    //----------------------------------------------------------------------------------------------------------------------
public slots:
    //----------------------------------------------------------------------------------------------------------------------
    /// @brief slot to set sim position
    /// @param _x - x position of our simulation
    /// @param _y - y position of our simulation
    /// @param _z - z position of our simualtion
    /// @param _simNo - simulation to set the position of
    //----------------------------------------------------------------------------------------------------------------------
    inline void setSimPosition(float _x, float _y, float _z,int _simNo = 0){m_fluidSimProps[_simNo].m_simPosition = ngl::Vec3(_x,_y,_z);}
    //----------------------------------------------------------------------------------------------------------------------
    /// @brief slot to add a fluid simulation to our scene
    //----------------------------------------------------------------------------------------------------------------------
    void addFluidSim();
    //----------------------------------------------------------------------------------------------------------------------
    /// @brief slot to load cube maps to for our enironment map
    /// @brief this function pressumes that all our cube map textures are in one texture
    /// @param _loc - the location of our cube map texture
    //----------------------------------------------------------------------------------------------------------------------
    void loadCubeMap(QString _loc);
    //----------------------------------------------------------------------------------------------------------------------
    /// @brief a slot to change our particle size
    /// @param _size - particle size
    /// @param _simNo - which simulation we want to change the particle size in
    //----------------------------------------------------------------------------------------------------------------------
    inline void setParticleSize(float _size, int _simNo = 0){m_fluidShaders[_simNo]->setPointSize(_size);}
    //----------------------------------------------------------------------------------------------------------------------
    /// @brief a slot to change our particle thickess
    /// @param _thickness - particle thickness
    /// @param _simNo - which simulation we want to change the thickness in
    //----------------------------------------------------------------------------------------------------------------------
    inline void setParticleThickness(float _thickness, int _simNo = 0){m_fluidShaders[_simNo]->setThickness(_thickness);}
    //----------------------------------------------------------------------------------------------------------------------
    /// @brief a slot to change our bilateral filter blur falloff
    /// @param _falloff - bilateral blur falloff
    /// @param _simNo - which simulation we want to change the blur fall off in
    //----------------------------------------------------------------------------------------------------------------------
    inline void setBlurFalloff(float _falloff, int _simNo = 0){m_fluidShaders[_simNo]->setBlurFalloff(_falloff);}
    //----------------------------------------------------------------------------------------------------------------------
    /// @brief a slot to change our bilateral filter blur radius
    /// @param _radius - bilateral blur radius
    /// @param _simNo - which simulation we want to change the blur radius in
    //----------------------------------------------------------------------------------------------------------------------
    inline void setBlurRadius(float _radius, int _simNo = 0){m_fluidShaders[_simNo]->setBlurRadius( _radius);}
    //----------------------------------------------------------------------------------------------------------------------
    /// @brief a slot to set the refraction ratio of our fluid
    /// @param _eta - desired refraction ratio
    /// @param _simNo - which simulation we want to change the rafraction ratio in
    //----------------------------------------------------------------------------------------------------------------------
    inline void setRafractionRatio(float _eta, int _simNo = 0){m_fluidShaders[_simNo]->setRefractionRatio(_eta);}
    //----------------------------------------------------------------------------------------------------------------------
    /// @brief a slot to set the fresnal power of our fluid
    /// @param _power - desired fresnal power of our fluid
    /// @param _simNo - which simulation we want to change the fresnal power in
    //----------------------------------------------------------------------------------------------------------------------
    inline void setFresnalPower(float _power,int _simNo = 0){m_fluidShaders[_simNo]->setFresnalPower(_power);}
    //----------------------------------------------------------------------------------------------------------------------
    /// @brief play/pause toggle slot
    /// @param _simNo - which simulation we want to toggle play
    //----------------------------------------------------------------------------------------------------------------------
    inline void playToggle(int _simNo = 0){m_fluidSimProps[_simNo].m_update = !m_fluidSimProps[_simNo].m_update;}
    //----------------------------------------------------------------------------------------------------------------------
    /// @brief set volume of our fluid slot
    /// @param _mass - desired mass of particles
    /// @param _simNo - which simulation we want to change
    //----------------------------------------------------------------------------------------------------------------------
    inline void setMass(float _mass, int _simNo = 0){m_SPHEngines[_simNo]->setParticleMass(_mass);}
    //----------------------------------------------------------------------------------------------------------------------
    /// @brief set density of our fluid slot
    /// @param _den - desired rest density
    /// @param _simNo - which simulation we want to change
    //----------------------------------------------------------------------------------------------------------------------
    inline void setDensity(float _den, int _simNo = 0){m_SPHEngines[_simNo]->setDesity(_den);}
    //----------------------------------------------------------------------------------------------------------------------
    /// @brief set viscoty coeficient of our fluid slot
    /// @param _visc - viscosity coeficient
    /// @param _simNo - which simulation we want to change
    //----------------------------------------------------------------------------------------------------------------------
    inline void setViscCoef(float _visc, int _simNo = 0){m_SPHEngines[_simNo]->setViscCoef(_visc);}
    //----------------------------------------------------------------------------------------------------------------------
    /// @brief set gas constant of our fluid slot
    /// @param _gasConst - gas constant
    /// @param _simNo - which simulation we want to change
    //----------------------------------------------------------------------------------------------------------------------
    inline void setGasConst(double _gasConst, int _simNo = 0){m_SPHEngines[_simNo]->setGasConstant(_gasConst);}
    //----------------------------------------------------------------------------------------------------------------------
    /// @brief set smoothing length of our fluid slot
    /// @param _len - smoothing length
    /// @param _simNo - which simulation we want to change our smoothing length in
    //----------------------------------------------------------------------------------------------------------------------
    inline void setSmoothingLength(float _len, int _simNo = 0){m_SPHEngines[_simNo]->setSmoothingLength(_len);}
    //----------------------------------------------------------------------------------------------------------------------
    /// @brief set the color of our fluid slot
    /// @param _col - desired color to set the fluid to
    /// @param _simNo - which simulation we want to change the color in
    //----------------------------------------------------------------------------------------------------------------------
    inline void setFluidColor(QColor _col, int _simNo = 0){m_fluidShaders[_simNo]->setColor(_col.redF(),_col.greenF(),_col.blueF());}
    //----------------------------------------------------------------------------------------------------------------------
    /// @brief a slot to set the playback speed of our simulation
    /// @param _speed - the speed of play back as a percentage 100.f is real time
    /// @param _simNo - which simulation we want to change the play back speed in
    //----------------------------------------------------------------------------------------------------------------------
    inline void setPlaybackSpeed(float _speed, int _simNo = 0){m_fluidSimProps[_simNo].m_playSpeed = _speed;}
    //----------------------------------------------------------------------------------------------------------------------
    /// @brief a slot to set the time step of our simulation
    /// @param _timeStep - the timeStep of our simulation
    /// @param _simNo - which simulation we want to change the play back speed in
    //----------------------------------------------------------------------------------------------------------------------
    inline void setSimTimeStep(float _timeStep, int _simNo = 0){m_fluidSimProps[_simNo].m_timeStep = _timeStep;}
    //----------------------------------------------------------------------------------------------------------------------
    /// @brief a slot to reset our simulation and remove all particles
    /// @brief _simNo - simulation number to reset
    //----------------------------------------------------------------------------------------------------------------------
    inline void resetSim(int _simNo){m_SPHEngines[_simNo]->signalReset();}
    //----------------------------------------------------------------------------------------------------------------------
    /// @brief a slot to set the spawn box position in our simulation
    /// @param _x - x position of spawn box location
    /// @param _y - y position of spawn box location
    /// @param _z - z position of spawn box location
    /// @param _simNo - simulation number to set the spawn box location
    //----------------------------------------------------------------------------------------------------------------------
    inline void setSpawnBoxPosition(float _x, float _y, float _z,int _simNo = 0){m_SPHEngines[_simNo]->setSpawnBoxPos(_x,_y,_z);}
    //----------------------------------------------------------------------------------------------------------------------
    /// @brief a slot to set the spawn box size in our simulation
    /// @param _size - desired spawn box size
    /// @param _simNo - simulation number to set the spawn box size
    //----------------------------------------------------------------------------------------------------------------------
    inline void setSpawnBoxSize(float _size,int _simNo = 0){m_SPHEngines[_simNo]->setSpawnBoxSize(_size);}
    //----------------------------------------------------------------------------------------------------------------------
    /// @brief slot to add particles to our simulation
    /// @param _numParticles - number of particles to add to simulation
    /// @param _simNo - simulation to add particles to
    //----------------------------------------------------------------------------------------------------------------------
    inline void addParticlesToSim(int _numParticles,int _simNo = 0){m_SPHEngines[_simNo]->signalAddParticles(_numParticles);}
    //----------------------------------------------------------------------------------------------------------------------
    /// @brief slot to set the velocity correction of our simulation
    /// @param _val - value of velocity correction
    /// @param _simNo - simulation to set velocity correction in
    //----------------------------------------------------------------------------------------------------------------------
    inline void setVelCorrection(float _val, int _simNo = 0){m_SPHEngines[_simNo]->setVelocityCorrection(_val);}
    //----------------------------------------------------------------------------------------------------------------------
    /// @brief slot to toggle display of the hud of our simulatio
    /// @param _display - bool to indicate if we want to display it or not
    /// @param _simNo - simulation we wish to display Hud
    //----------------------------------------------------------------------------------------------------------------------
    inline void setDisplayHud(bool _display, int _simNo = 0){m_fluidSimProps[_simNo].m_displayHud = _display;}
    //----------------------------------------------------------------------------------------------------------------------

private:
    //----------------------------------------------------------------------------------------------------------------------
    /// @brief dummy VAO to for drawing our VAO
    //----------------------------------------------------------------------------------------------------------------------
    GLuint m_cubeVAO;
    //----------------------------------------------------------------------------------------------------------------------
    /// @brief structure to hold some update information about our fluid simulations
    //----------------------------------------------------------------------------------------------------------------------
    struct fluidSimProps{
        //----------------------------------------------------------------------------------------------------------------------
        /// @brief vector of our simulation positions
        //----------------------------------------------------------------------------------------------------------------------
        ngl::Vec3 m_simPosition;
        //----------------------------------------------------------------------------------------------------------------------
        /// @brief the timestep to increment ouf simulation
        //----------------------------------------------------------------------------------------------------------------------
        float m_timeStep;
        //----------------------------------------------------------------------------------------------------------------------
        /// @brief a bool to tell us if we need to update our simulation
        //----------------------------------------------------------------------------------------------------------------------
        bool m_update;
        //----------------------------------------------------------------------------------------------------------------------
        /// @brief play speed
        //----------------------------------------------------------------------------------------------------------------------
        float m_playSpeed;
        //----------------------------------------------------------------------------------------------------------------------
        /// @brief bool to indicate if we want to update with a set time step or with actual time
        //----------------------------------------------------------------------------------------------------------------------
        bool m_updateWithFixedTimeStep;
        //----------------------------------------------------------------------------------------------------------------------
        /// @brief bool to indicate if we want to display the HUD
        //----------------------------------------------------------------------------------------------------------------------
        bool m_displayHud;
        //----------------------------------------------------------------------------------------------------------------------
    };
    //----------------------------------------------------------------------------------------------------------------------
    /// @brief update information abour our simulations
    //----------------------------------------------------------------------------------------------------------------------
    std::vector<fluidSimProps> m_fluidSimProps;
    //----------------------------------------------------------------------------------------------------------------------
    /// @brief Our SPHEngine that manages our particles.
    //----------------------------------------------------------------------------------------------------------------------
    std::vector<SPHEngine *> m_SPHEngines;
    //----------------------------------------------------------------------------------------------------------------------
    /// @brief Our fluid shader
    //----------------------------------------------------------------------------------------------------------------------
    std::vector<FluidShader *> m_fluidShaders;
    //----------------------------------------------------------------------------------------------------------------------
    /// @brief used for calculating framerate
    //----------------------------------------------------------------------------------------------------------------------
    QTime m_currentTime;
    //----------------------------------------------------------------------------------------------------------------------
    /// @brief used for drawing text in openGL
    //----------------------------------------------------------------------------------------------------------------------
    ngl::Text *m_text;
    //----------------------------------------------------------------------------------------------------------------------
    /// @brief Our Camera
    //----------------------------------------------------------------------------------------------------------------------
    ngl::Camera *m_cam;
    //----------------------------------------------------------------------------------------------------------------------
    /// @brief Model matrix
    //----------------------------------------------------------------------------------------------------------------------
    ngl::Mat4 m_modelMatrix;
    //----------------------------------------------------------------------------------------------------------------------
    /// @brief Normal Matrix
    //----------------------------------------------------------------------------------------------------------------------
    ngl::Mat4 m_normalMatrix;
    //----------------------------------------------------------------------------------------------------------------------
    /// @brief Mouse transforms
    //----------------------------------------------------------------------------------------------------------------------
    ngl::Mat4 m_mouseGlobalTX;
    //----------------------------------------------------------------------------------------------------------------------
    /// @brief model pos
    //----------------------------------------------------------------------------------------------------------------------
    ngl::Vec3 m_modelPos;
    //----------------------------------------------------------------------------------------------------------------------
    /// @brief Spin face x
    //----------------------------------------------------------------------------------------------------------------------
    float m_spinXFace;
    //----------------------------------------------------------------------------------------------------------------------
    /// @brief Sping face y
    //----------------------------------------------------------------------------------------------------------------------
    float m_spinYFace;
    //----------------------------------------------------------------------------------------------------------------------
    /// @brief rotate bool
    //----------------------------------------------------------------------------------------------------------------------
    bool m_rotate;
    //----------------------------------------------------------------------------------------------------------------------
    /// @brief translate bool
    //----------------------------------------------------------------------------------------------------------------------
    bool m_translate;
    //----------------------------------------------------------------------------------------------------------------------
    /// @brief
    //----------------------------------------------------------------------------------------------------------------------
    int m_origX;
    //----------------------------------------------------------------------------------------------------------------------
    /// @brief
    //----------------------------------------------------------------------------------------------------------------------
    int m_origY;
    //----------------------------------------------------------------------------------------------------------------------
    /// @brief
    //----------------------------------------------------------------------------------------------------------------------
    int m_origXPos;
    //----------------------------------------------------------------------------------------------------------------------
    /// @brief
    //----------------------------------------------------------------------------------------------------------------------
    int m_origYPos;
    //----------------------------------------------------------------------------------------------------------------------
    /// @brief bool to indicate if we want to pan our camera
    //----------------------------------------------------------------------------------------------------------------------
    bool m_pan;
    //----------------------------------------------------------------------------------------------------------------------

};

#endif // OPENGLWIDGET_H
